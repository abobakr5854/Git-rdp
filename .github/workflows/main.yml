name: Simple RDP with Bore Tunnel

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ'
        required: true
        default: 'user'
      password:
        description: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±'
        required: true
        default: 'Pass123!'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
    - name: ØªÙ†Ø¸ÛŒÙ… RDP
      run: |
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
        $username = "${{ github.event.inputs.username }}"
        $password = "${{ github.event.inputs.password }}" | ConvertTo-SecureString -AsPlainText -Force
        
        try {
            New-LocalUser -Name $username -Password $password -Description "RDP User" -PasswordNeverExpires -ErrorAction Stop
            Write-Host "Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: $username"
        } catch {
            Set-LocalUser -Name $username -Password $password
            Write-Host "Ø±Ù…Ø² Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±ÙˆØ² Ø´Ø¯: $username"
        }
        
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue

    - name: Ø¯Ø§Ù†Ù„ÙˆØ¯ Bore
      run: |
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/latest/download/bore-v0.5.1-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive bore.zip -DestinationPath .
        Write-Host "Bore Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯!"

    - name: Ø´Ø±ÙˆØ¹ Bore Tunnel
      run: |
        Write-Host "Ø´Ø±ÙˆØ¹ Bore tunnel..."
        Start-Process -FilePath ".\bore.exe" -ArgumentList "local", "3389", "--to", "bore.pub" -WindowStyle Hidden -PassThru
        Start-Sleep -Seconds 5
        
        Write-Host "ğŸ”— Bore tunnel Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!"

    - name: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
      run: |
        Write-Host "=============== Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ RDP ==============="
        Write-Host "ğŸ–¥ï¸  Ø³Ø±ÙˆØ±: Windows GitHub Actions"
        Write-Host "ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: ${{ github.event.inputs.username }}"
        Write-Host "ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: ${{ github.event.inputs.password }}"
        Write-Host "ğŸŒ Ø¢Ø¯Ø±Ø³: bore.pub"
        Write-Host "ğŸ”Œ Ù¾ÙˆØ±Øª: Ù…ØªØºÛŒØ± (Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ù…Ø´Ø®Øµ Ù…ÛŒâ€ŒØ´ÙˆØ¯)"
        Write-Host ""
        Write-Host "âš¡ Ø§ØªØµØ§Ù„ Ø³Ø±ÛŒØ¹: Ø¯Ø± Remote Desktop Connection ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"
        Write-Host "   Ø¢Ø¯Ø±Ø³: bore.pub:PORT"
        Write-Host "   (PORT Ø±Ø§ Ø§Ø² Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§Ù„Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯)"
        Write-Host "=============================================="

    - name: Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡
      run: |
        Write-Host "ğŸ”„ Ø³Ø±ÙˆØ± ÙØ¹Ø§Ù„ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯..."
        $i = 0
        while($true) {
            Start-Sleep 30
            $i++
            Write-Host "âœ… ÙØ¹Ø§Ù„ - $i Ø¯Ù‚ÛŒÙ‚Ù‡ Ú¯Ø°Ø´Øª"
            
            # Ø¨Ø±Ø±Ø³ÛŒ Bore
            $boreProcess = Get-Process bore -ErrorAction SilentlyContinue
            if(-not $boreProcess) {
                Write-Host "âš ï¸ Bore Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡ØŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯..."
                Start-Process -FilePath ".\bore.exe" -ArgumentList "local", "3389", "--to", "bore.pub" -WindowStyle Hidden
            }
        }
