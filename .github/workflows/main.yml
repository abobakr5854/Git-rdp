name: Simple RDP with LocalTunnel

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ'
        required: true
        default: 'user'
      password:
        description: 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±'
        required: true
        default: 'Pass123!'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
    - name: ØªÙ†Ø¸ÛŒÙ… RDP
      run: |
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
        $username = "${{ github.event.inputs.username }}"
        $password = "${{ github.event.inputs.password }}" | ConvertTo-SecureString -AsPlainText -Force
        
        try {
            New-LocalUser -Name $username -Password $password -Description "RDP User" -PasswordNeverExpires -ErrorAction Stop
            Write-Host "âœ… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯: $username"
        } catch {
            Set-LocalUser -Name $username -Password $password
            Write-Host "âœ… Ø±Ù…Ø² Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±ÙˆØ² Ø´Ø¯: $username"
        }
        
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        
        Write-Host "ğŸ” RDP ÙØ¹Ø§Ù„ Ø´Ø¯!"

    - name: Ù†ØµØ¨ Node.js Ùˆ LocalTunnel
      run: |
        Write-Host "ğŸ“¦ Ù†ØµØ¨ Node.js..."
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ù†ØµØ¨ Node.js
        $nodeUrl = "https://nodejs.org/dist/v18.17.0/node-v18.17.0-win-x64.zip"
        Invoke-WebRequest -Uri $nodeUrl -OutFile "node.zip"
        Expand-Archive node.zip -DestinationPath "."
        
        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Node Ø¨Ù‡ PATH
        $nodePath = "$(Get-Location)\node-v18.17.0-win-x64"
        $env:PATH = "$nodePath;$env:PATH"
        
        Write-Host "âœ… Node.js Ù†ØµØ¨ Ø´Ø¯"
        & "$nodePath\node.exe" --version
        
        # Ù†ØµØ¨ LocalTunnel
        Write-Host "ğŸ“¡ Ù†ØµØ¨ LocalTunnel..."
        & "$nodePath\npm.cmd" install -g localtunnel
        
        Write-Host "âœ… LocalTunnel Ù†ØµØ¨ Ø´Ø¯"

    - name: Ø´Ø±ÙˆØ¹ LocalTunnel
      run: |
        Write-Host "ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ LocalTunnel..."
        
        # ØªÙ†Ø¸ÛŒÙ… PATH
        $nodePath = "$(Get-Location)\node-v18.17.0-win-x64"
        $env:PATH = "$nodePath;$env:PATH"
        
        # Ø´Ø±ÙˆØ¹ LocalTunnel
        $subdomain = "github-rdp-${{ github.run_id }}"
        
        Write-Host "ğŸ”— Ø´Ø±ÙˆØ¹ tunnel Ø¨Ø§ subdomain: $subdomain"
        
        Start-Job -Name "LocalTunnel" -ScriptBlock {
            param($nodePath, $subdomain)
            $env:PATH = "$nodePath;$env:PATH"
            & "$nodePath\npx.cmd" localtunnel --port 3389 --subdomain $subdomain
        } -ArgumentList $nodePath, $subdomain
        
        Start-Sleep -Seconds 10
        
        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª
        $job = Get-Job -Name "LocalTunnel"
        if ($job.State -eq "Running") {
            Write-Host "âœ… LocalTunnel Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯"
        } else {
            Write-Host "âš ï¸ Ù…Ø´Ú©Ù„ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ LocalTunnel"
            Receive-Job $job
        }

    - name: ØªÙ†Ø¸ÛŒÙ… SSH Tunnel (Ø±ÙˆØ´ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†)
      run: |
        Write-Host "ğŸ”§ ØªÙ†Ø¸ÛŒÙ… SSH Tunnel Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† backup..."
        
        # Ø¯Ø§Ù†Ù„ÙˆØ¯ OpenSSH client (Ø§Ú¯Ø± Ù†ÛŒØ§Ø² Ø¨Ø§Ø´Ø¯)
        Write-Host "ğŸ“¥ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ SSH client..."
        
        # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ batch Ø¨Ø±Ø§ÛŒ SSH tunnel
        @"
@echo off
echo Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SSH tunnel...
ssh -R 3389:localhost:3389 serveo.net
"@ | Out-File -FilePath "ssh-tunnel.bat" -Encoding ASCII
        
        Write-Host "âœ… ÙØ§ÛŒÙ„ SSH tunnel Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯"

    - name: Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
      run: |
        Write-Host ""
        Write-Host "=============== ğŸ”— Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ RDP ==============="
        Write-Host ""
        Write-Host "ğŸ–¥ï¸  Ø³Ø±ÙˆØ±: Windows GitHub Actions"
        Write-Host "ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: ${{ github.event.inputs.username }}"
        Write-Host "ğŸ”‘ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±: ${{ github.event.inputs.password }}"
        Write-Host ""
        Write-Host "ğŸŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø§ØªØµØ§Ù„:"
        Write-Host "   1ï¸âƒ£ LocalTunnel: https://github-rdp-${{ github.run_id }}.loca.lt"
        Write-Host "   2ï¸âƒ£ SSH Tunnel: ssh -R 3389:localhost:3389 serveo.net"
        Write-Host ""
        Write-Host "ğŸ“± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ RDP:"
        Write-Host "   â€¢ Windows: mstsc /v:github-rdp-${{ github.run_id }}.loca.lt:443"
        Write-Host "   â€¢ Mac: Microsoft Remote Desktop"
        Write-Host "   â€¢ Mobile: RD Client"
        Write-Host ""
        Write-Host "âš¡ Ù†Ú©Ø§Øª Ù…Ù‡Ù…:"
        Write-Host "   â€¢ Ø§Ú¯Ø± LocalTunnel Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² SSH Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯"
        Write-Host "   â€¢ Ø¬Ù„Ø³Ù‡ ØªØ§ 5 Ø³Ø§Ø¹Øª ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯"
        Write-Host "   â€¢ Ø¨Ø±Ø§ÛŒ Ù‚Ø·Ø¹ Ú©Ø±Ø¯Ù†ØŒ Ø¯Ø± Actions Ø±ÙˆÛŒ Cancel Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯"
        Write-Host ""
        Write-Host "=============================================="

    - name: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SSH Tunnel Ø§Ø¶Ø§ÙÛŒ
      run: |
        Write-Host "ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ SSH tunnel Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† backup..."
        
        # ØªØ³Øª SSH
        try {
            Write-Host "ğŸ§ª ØªØ³Øª Ø§ØªØµØ§Ù„ SSH..."
            # Ø§ÛŒÙ† Ù‚Ø³Ù…Øª ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³Øª
            Write-Host "ğŸ“‹ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¯Ø³ØªÛŒ SSH tunnel:"
            Write-Host "   ssh -R 3389:localhost:3389 serveo.net"
            Write-Host "âœ… SSH tunnel Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª"
        } catch {
            Write-Host "âš ï¸ SSH Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³ØªØŒ LocalTunnel Ø±Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯"
        }

    - name: Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡ Ùˆ Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯
      run: |
        Write-Host "ğŸ”„ Ø´Ø±ÙˆØ¹ Ø­Ù„Ù‚Ù‡ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ø¬Ù„Ø³Ù‡..."
        Write-Host "â° Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹: $(Get-Date)"
        
        $counter = 0
        while($true) {
            Start-Sleep 60  # Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ú†Ú© Ú©Ù†
            $counter++
            
            $hours = [math]::Floor($counter / 60)
            $minutes = $counter % 60
            
            Write-Host "â±ï¸  ÙØ¹Ø§Ù„: $hours Ø³Ø§Ø¹Øª Ùˆ $minutes Ø¯Ù‚ÛŒÙ‚Ù‡"
            
            # Ø¨Ø±Ø±Ø³ÛŒ LocalTunnel job
            $ltJob = Get-Job -Name "LocalTunnel" -ErrorAction SilentlyContinue
            if ($ltJob) {
                if ($ltJob.State -eq "Running") {
                    Write-Host "âœ… LocalTunnel ÙØ¹Ø§Ù„ Ø§Ø³Øª"
                } else {
                    Write-Host "âš ï¸ LocalTunnel Ù…ØªÙˆÙ‚Ù Ø´Ø¯Ù‡ØŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯..."
                    Remove-Job $ltJob -Force
                    
                    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯
                    $nodePath = "$(Get-Location)\node-v18.17.0-win-x64"
                    $subdomain = "github-rdp-${{ github.run_id }}"
                    
                    Start-Job -Name "LocalTunnel" -ScriptBlock {
                        param($nodePath, $subdomain)
                        $env:PATH = "$nodePath;$env:PATH"
                        & "$nodePath\npx.cmd" localtunnel --port 3389 --subdomain $subdomain
                    } -ArgumentList $nodePath, $subdomain
                }
            }
            
            # Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„ Ø±Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
            if ($counter % 10 -eq 0) {
                Write-Host ""
                Write-Host "ğŸ”— Ø¢Ø¯Ø±Ø³ Ø§ØªØµØ§Ù„: https://github-rdp-${{ github.run_id }}.loca.lt"
                Write-Host "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: ${{ github.event.inputs.username }}"
                Write-Host "ğŸ”‘ Ø±Ù…Ø²: ${{ github.event.inputs.password }}"
                Write-Host ""
            }
            
            # ÙØ¹Ø§Ù„ÛŒØª Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®ÙˆØ§Ø¨
            try {
                [System.Reflection.Assembly]::LoadWithPartialName("System.Windows.Forms") | Out-Null
                $pos = [System.Windows.Forms.Cursor]::Position
                [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point(($pos.X + 1), $pos.Y)
                Start-Sleep -Milliseconds 100
                [System.Windows.Forms.Cursor]::Position = $pos
            } catch {
                # Ø§Ú¯Ø± Ù†ØªÙˆÙ†Ø³Øª cursor Ø±Ùˆ Ø­Ø±Ú©Øª Ø¨Ø¯Ù‡ØŒ Ù…Ø´Ú©Ù„ÛŒ Ù†ÛŒØ³Øª
            }
        }
