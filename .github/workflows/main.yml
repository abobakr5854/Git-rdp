name: Ultra Simple RDP Server (FRP - improved logging & port extraction)

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username'
        required: true
        default: 'user'
      password:
        description: 'Password'
        required: true
        default: 'Pass123!'

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup RDP (enable)
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
        Enable-NetFirewallRule -DisplayGroup 'Remote Desktop' -ErrorAction SilentlyContinue

        $username = '${{ github.event.inputs.username }}'
        $passwordPlain = '${{ github.event.inputs.password }}'
        $securePass = ConvertTo-SecureString $passwordPlain -AsPlainText -Force

        try {
            New-LocalUser -Name $username -Password $securePass -PasswordNeverExpires -ErrorAction Stop
            Write-Host "Created user $username"
        } catch {
            Write-Host "User may already exist, attempting to set password"
            try {
                Set-LocalUser -Name $username -Password $securePass -ErrorAction Stop
                Write-Host "Password set for $username"
            } catch {
                Write-Host "Warning: failed to create or update user: $_"
            }
        }

        Add-LocalGroupMember -Group 'Remote Desktop Users' -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group 'Administrators' -Member $username -ErrorAction SilentlyContinue
        Write-Host 'RDP enabled and user configured.'

    - name: Download FRP (release v0.52.3)
      shell: powershell
      run: |
        $url = 'https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_windows_amd64.zip'
        $out = 'frp.zip'
        Invoke-WebRequest $url -OutFile $out -UseBasicParsing
        Expand-Archive $out -DestinationPath . -Force
        Copy-Item 'frp_0.52.3_windows_amd64\frpc.exe' -Destination 'frpc.exe' -Force
        Write-Host 'FRP downloaded.'

    - name: Create frpc.ini
      shell: powershell
      run: |
        $cfg = @'
        [common]
        server_addr = frp.freefrp.net
        server_port = 7000

        [rdp]
        type = tcp
        local_ip = 127.0.0.1
        local_port = 3389
        remote_port = 0
        '@
        $cfg | Out-File -FilePath 'frpc.ini' -Encoding ASCII -Force
        Write-Host 'frpc.ini written.'

    - name: Start frpc (detached) and try to extract assigned port
      shell: powershell
      run: |
        # حذف لاگ قبلی
        if (Test-Path 'frp.log') { Remove-Item 'frp.log' -Force }

        Write-Host "Starting frpc (detached) and redirecting output to frp.log..."
        # از cmd.exe start /b استفاده می‌کنیم تا فرایند جدا شده و runner ادامه پیدا کنه
        $startCmd = 'start /b "" .\frpc.exe -c frpc.ini > frp.log 2>&1'
        Start-Process -FilePath 'cmd.exe' -ArgumentList '/c', $startCmd -WindowStyle Hidden

        # حالا صبر کن و لاگ را بررسی کن تا پورت رو پیدا کنیم
        $maxWaitSeconds = 30
        $foundPort = $null
        for ($i = 0; $i -lt $maxWaitSeconds; $i++) {
            Start-Sleep -Seconds 1
            if (Test-Path -Path 'frp.log') {
                $lines = Get-Content -Path 'frp.log' -ErrorAction SilentlyContinue
                foreach ($l in $lines) {
                    # چند الگو برای پیدا کردن پورت تلاش می‌کنیم
                    if ($l -match 'remote_port\s*[:=]?\s*(\d{2,5})') { $foundPort = $matches[1]; break }
                    if ($l -match 'listening.*:(\d{2,5})') { $foundPort = $matches[1]; break }
                    if ($l -match 'address.*:(\d{2,5})') { $foundPort = $matches[1]; break }
                    if ($l -match ':(\d{4,5})(\D|$)') { $foundPort = $matches[1]; break }
                }
                if ($foundPort) { break }
            }
        }

        if ($foundPort) {
            Write-Host "=== FRP assigned remote port: $foundPort ==="
            echo "FRP_REMOTE_PORT=$foundPort" | Out-File -FilePath $env:GITHUB_ENV -Encoding ASCII -Append
        } else {
            Write-Host "Could not determine assigned remote port within $maxWaitSeconds seconds."
            Write-Host "---- Last 120 lines of frp.log for debug ----"
            if (Test-Path -Path 'frp.log') {
                Get-Content -Path 'frp.log' -Tail 120 | ForEach-Object { Write-Host $_ }
            } else {
                Write-Host "(frp.log not found)"
            }
            # آپلود لاگ برای دانلود و بررسی محلی
            Write-Host "Will upload frp.log as artifact for debugging."
        }

    - name: Upload frp.log (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: frp-log
        path: frp.log

    - name: Connection Info (with extracted port if any)
      shell: powershell
      run: |
        $srv = 'frp.freefrp.net'
        $usr = '${{ github.event.inputs.username }}'
        $pwd = '${{ github.event.inputs.password }}'
        $port = $env:FRP_REMOTE_PORT
        Write-Host '===================='
        Write-Host 'RDP CONNECTION INFO'
        Write-Host '===================='
        if ($port) {
            Write-Host "Server: $srv:$port"
        } else {
            Write-Host "Server: $srv (port not detected — download frp.log artifact and inspect)"
        }
        Write-Host "Username: $usr"
        Write-Host "Password: $pwd"
        Write-Host '===================='
