name: Simple RDP with Bore Tunnel

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'نام کاربری'
        required: true
        default: 'user'
      password:
        description: 'رمز عبور'
        required: true
        default: 'Pass123!'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
    - name: تنظیم RDP
      run: |
        # فعال کردن RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        # ایجاد کاربر
        $username = "${{ github.event.inputs.username }}"
        $password = "${{ github.event.inputs.password }}" | ConvertTo-SecureString -AsPlainText -Force
        
        try {
            New-LocalUser -Name $username -Password $password -Description "RDP User" -PasswordNeverExpires -ErrorAction Stop
            Write-Host "کاربر جدید ایجاد شد: $username"
        } catch {
            Set-LocalUser -Name $username -Password $password
            Write-Host "رمز کاربر بروز شد: $username"
        }
        
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue

    - name: دانلود Bore
      run: |
        # دانلود مستقیم فایل اجرایی Bore
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/download/v0.5.1/bore-v0.5.1-x86_64-pc-windows-msvc.exe" -OutFile "bore.exe"
        Write-Host "Bore دانلود شد!"
        
        # بررسی دانلود
        if (Test-Path "bore.exe") {
            Write-Host "✅ فایل bore.exe آماده است"
            $fileSize = (Get-Item "bore.exe").Length
            Write-Host "📦 سایز فایل: $($fileSize / 1MB) MB"
        } else {
            Write-Host "❌ خطا در دانلود Bore"
            exit 1
        }

    - name: شروع Bore Tunnel
      run: |
        Write-Host "شروع Bore tunnel..."
        
        # اجرای Bore و گرفتن خروجی
        $boreJob = Start-Job -ScriptBlock {
            & ".\bore.exe" local 3389 --to bore.pub 2>&1
        }
        
        Start-Sleep -Seconds 10
        
        # دریافت خروجی Bore
        $output = Receive-Job $boreJob -Keep
        Write-Host "📡 خروجی Bore:"
        Write-Host $output
        
        # استخراج پورت از خروجی
        if ($output -match "bore\.pub:(\d+)") {
            $port = $matches[1]
            Write-Host "🎯 پورت اتصال: $port"
            Write-Host "🔗 آدرس کامل: bore.pub:$port"
        } else {
            Write-Host "⚠️ نتوانست پورت را تشخیص دهد، خروجی کامل را بررسی کنید"
        }
        
        Write-Host "✅ Bore tunnel راه‌اندازی شد!"

    - name: اطلاعات اتصال
      run: |
        Write-Host "=============== اطلاعات اتصال RDP ==============="
        Write-Host "🖥️  سرور: Windows GitHub Actions"
        Write-Host "👤 نام کاربری: ${{ github.event.inputs.username }}"
        Write-Host "🔑 رمز عبور: ${{ github.event.inputs.password }}"
        Write-Host "🌍 آدرس: bore.pub"
        Write-Host "🔌 پورت: متغیر (در لاگ‌ها مشخص می‌شود)"
        Write-Host ""
        Write-Host "⚡ اتصال سریع: در Remote Desktop Connection وارد کنید:"
        Write-Host "   آدرس: bore.pub:PORT"
        Write-Host "   (PORT را از خروجی بالا کپی کنید)"
        Write-Host "=============================================="

    - name: نگه‌داری جلسه
      run: |
        Write-Host "🔄 سرور فعال نگه داشته می‌شود..."
        $i = 0
        while($true) {
            Start-Sleep 30
            $i++
            Write-Host "✅ فعال - $i دقیقه گذشت"
            
            # بررسی Job های Bore
            $boreJobs = Get-Job | Where-Object {$_.State -eq "Running"}
            if($boreJobs.Count -eq 0) {
                Write-Host "⚠️ Bore متوقف شده، راه‌اندازی مجدد..."
                $newBoreJob = Start-Job -ScriptBlock {
                    & ".\bore.exe" local 3389 --to bore.pub 2>&1
                }
                Start-Sleep -Seconds 5
                $newOutput = Receive-Job $newBoreJob -Keep
                Write-Host "🔄 خروجی جدید Bore: $newOutput"
            }
            
            # نمایش اطلاعات اتصال هر 5 دقیقه
            if($i % 10 -eq 0) {
                Write-Host "🔗 برای اتصال RDP به bore.pub استفاده کنید"
                Write-Host "👤 کاربری: ${{ github.event.inputs.username }}"
                Write-Host "🔑 رمز: ${{ github.event.inputs.password }}"
            }
        }
