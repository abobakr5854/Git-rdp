name: Simple RDP with LocalTunnel

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'نام کاربری'
        required: true
        default: 'user'
      password:
        description: 'رمز عبور'
        required: true
        default: 'Pass123!'

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: 300

    steps:
    - name: تنظیم RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        
        $username = "${{ github.event.inputs.username }}"
        $password = "${{ github.event.inputs.password }}" | ConvertTo-SecureString -AsPlainText -Force
        
        try {
            New-LocalUser -Name $username -Password $password -Description "RDP User" -PasswordNeverExpires -ErrorAction Stop
            Write-Host "کاربر جدید ایجاد شد: $username"
        } catch {
            Set-LocalUser -Name $username -Password $password
            Write-Host "رمز کاربر بروز شد: $username"
        }
        
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username -ErrorAction SilentlyContinue
        Add-LocalGroupMember -Group "Administrators" -Member $username -ErrorAction SilentlyContinue
        
        Write-Host "RDP فعال شد!"

    - name: نصب Node.js
      run: |
        Write-Host "نصب Node.js..."
        choco install nodejs -y
        Write-Host "Node.js نصب شد"
        node --version
        npm --version

    - name: نصب LocalTunnel
      run: |
        Write-Host "نصب LocalTunnel..."
        npm install -g localtunnel
        Write-Host "LocalTunnel نصب شد"

    - name: شروع LocalTunnel
      run: |
        Write-Host "راه اندازی LocalTunnel..."
        $subdomain = "github-rdp-${{ github.run_id }}"
        
        Start-Job -Name "LocalTunnel" -ScriptBlock {
            param($subdomain)
            npx localtunnel --port 3389 --subdomain $subdomain
        } -ArgumentList $subdomain
        
        Start-Sleep -Seconds 15
        
        $job = Get-Job -Name "LocalTunnel"
        if ($job.State -eq "Running") {
            Write-Host "LocalTunnel راه اندازی شد"
            Write-Host "آدرس: https://$subdomain.loca.lt"
        } else {
            Write-Host "مشکل در راه اندازی LocalTunnel"
            Receive-Job $job
        }

    - name: اطلاعات اتصال
      run: |
        Write-Host "=============== اطلاعات اتصال RDP ==============="
        Write-Host "سرور: Windows GitHub Actions"
        Write-Host "نام کاربری: ${{ github.event.inputs.username }}"
        Write-Host "رمز عبور: ${{ github.event.inputs.password }}"
        Write-Host "آدرس: https://github-rdp-${{ github.run_id }}.loca.lt"
        Write-Host "پورت: 443 (HTTPS tunnel)"
        Write-Host ""
        Write-Host "برای اتصال RDP:"
        Write-Host "آدرس: github-rdp-${{ github.run_id }}.loca.lt:443"
        Write-Host "=============================================="

    - name: نگه داری جلسه
      run: |
        Write-Host "سرور فعال نگه داشته می شود..."
        $counter = 0
        while($true) {
            Start-Sleep 60
            $counter++
            Write-Host "فعال: $counter دقیقه"
            
            $ltJob = Get-Job -Name "LocalTunnel" -ErrorAction SilentlyContinue
            if ($ltJob -and $ltJob.State -ne "Running") {
                Write-Host "راه اندازی مجدد LocalTunnel..."
                Remove-Job $ltJob -Force
                
                $subdomain = "github-rdp-${{ github.run_id }}"
                Start-Job -Name "LocalTunnel" -ScriptBlock {
                    param($subdomain)
                    npx localtunnel --port 3389 --subdomain $subdomain
                } -ArgumentList $subdomain
            }
            
            if ($counter % 5 -eq 0) {
                Write-Host "آدرس اتصال: https://github-rdp-${{ github.run_id }}.loca.lt"
                Write-Host "کاربر: ${{ github.event.inputs.username }}"
            }
        }
